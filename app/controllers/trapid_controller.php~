<?php
App::import("Sanitize");
/*
 * General controller class for the trapid functionality
 */
class TrapidController extends AppController{
  var $name		= "Trapid";
  var $helpers		= array("Html","Form","Javascript","Ajax");

  var $uses		= array("Authentication","Experiments","DataSources","Transcripts","GeneFamilies",
				"TranscriptsGo","TranscriptsInterpro","TranscriptsLabels","TranscriptsPagination","Similarities",

				"AnnotSources","Annotation","ExtendedGo","ProteinMotifs","GfData"
				);

  var $components	= array("Cookie","TrapidUtils");
  var $paginate		= array(
				"Transcripts"=>
					array(
						"limit"=>10,
			       			"order"=>array("Transcripts.transcript_id"=>"ASC")					
				  	),			
				"TranscriptsPagination"=>
					array(
					      "limit"=>10,
					      "order"=>array("transcript_id"=>"ASC")	
					)
			  );



  function qdel_experiment(){
    $exp_id	= "36";
    $cluster_id = "373";
    $qdel_file	= $this->TrapidUtils->create_qdel_script($exp_id);
    $out	= array();
    exec("sh ".$qdel_file." ".$cluster_id." 2>&1",$out);
    pr($out);
  }  

  function clear_framedp_evaluation(){
    $exp_id			= "39";
    $tmp_dir			= TMP."experiment_data/".$exp_id."/";	
    $framedp_dir_eval		= $tmp_dir."framedp/evaluation/";
    shell_exec("rm -rf ".$framedp_dir_eval);	
    $framedp_dir_results	= $tmp_dir."framedp/training/000/";
    shell_exec("rm -rf ".$framedp_dir_results);
  }

  function clear_framedp(){
    $exp_id			= "25";
    $tmp_dir			= TMP."experiment_data/".$exp_id."/";	
    $framedp_dir		= $tmp_dir."framedp/";
    shell_exec("rm -rf ".$framedp_dir);
  }

  function clear_framedp_training(){
    $exp_id			= "25";
    $tmp_dir			= TMP."experiment_data/".$exp_id."/";	
    $framedp_dir		= $tmp_dir."framedp/";
    $framedp_dir_training	= $framedp_dir."training/";
    if(!(file_exists($framedp_dir_training) && is_dir($framedp_dir_training))){
	  mkdir($framedp_dir_training);
	  shell_exec("chmod a+rw ".$framedp_dir_training);
    }
    else{
	  //delete previous content for now!!!
	  shell_exec("rm -rf ".$framedp_dir_training."*");
    }		

  }


  /**
   * Entry page of the TRAPID online website. 
   * Only displays some information and a login-screen.
   * Skips right to experiments overview if user is already logged in.
   */
  function index(){   
      	$user_id	= $this->Cookie->read("user_id");
      	$email		= $this->Cookie->read("email");
      	$user_id  	= mysql_real_escape_string($user_id);
      	$email		= mysql_real_escape_string($email);
      	$user_data	= $this->Authentication->find("first",array("conditions"=>array("user_id"=>$user_id,"email"=>$email)));
	if($user_data){$this->redirect(array("controller"=>"trapid","action"=>"experiments"));}

	//test email
	//mail("mibel@psb.ugent.be","test email","blablabla");
	
  }



  /*
   * Displays experiment information for a given user
   */
  function experiments(){   
    $MAX_USER_EXPERIMENTS	= 10;
    $this->set("max_user_experiments",$MAX_USER_EXPERIMENTS);

    //check whether valid user id.
    //$user_id 		= $this->check_user();
    $user_id		= parent::check_user();
	
    //retrieve information about the user
    $user_email		= $this->Authentication->find("first",array("fields"=>array("email"),"conditions"=>array("user_id"=>$user_id)));
    $this->set("user_email",$user_email);
	

    //retrieve possible available PLAZA databases from the configuration table
    $available_sources	= $this->DataSources->find("all");    
    $this->set("available_sources",$available_sources);

    //retrieve current user experiments. 
    $experiments	= $this->Experiments->getUserExperiments($user_id);
    /*
    $experiments	= $this->Experiments->query("SELECT Experiments.*,count(Transcripts.`transcript_id`) as count, DataSources.`name`,DataSources.`URL` FROM `data_sources` DataSources, `experiments` Experiments  LEFT JOIN `transcripts` Transcripts on Experiments.`experiment_id`=Transcripts.`experiment_id` WHERE Experiments.user_id='".$user_id."' AND DataSources.`db_name`=Experiments.`used_plaza_database` GROUP BY Experiments.`experiment_id` ORDER BY Experiments.`last_edit_date` DESC");   
    pr($experiments);*/
    $this->set("experiments",$experiments);

    //check if post
    if($_POST){
      if(array_key_exists("experiment_name",$_POST) && array_key_exists("experiment_description",$_POST) && array_key_exists("data_source",$_POST)){
       	$experiment_name	= mysql_real_escape_string($_POST['experiment_name']);
	$experiment_description	= mysql_real_escape_string($_POST['experiment_description']);
	$data_source		= mysql_real_escape_string($_POST['data_source']);
	
	//check whether person has not already reached the limit of number of experiments (normally form should be disabled as well)
	if(count($experiments)>=$MAX_USER_EXPERIMENTS){
	  $this->set("error","Maximum experiments reached for this user account");
	  return;
	}
	
	//check whether valid plaza version is selected	
	$data_source_name	= null;
	foreach($available_sources as $as){
	  if($as['DataSources']['db_name']==$data_source){$data_source_name=$as['DataSources']['name'];}
	}
	if($data_source_name==null){
	  $this->set("error","Unknown data source selected. Please contact website administrator");
	  return;
	}
	
	//ok, checks are passed, now simply create new experiment in the database
	$this->Experiments->save(array("user_id"=>$user_id,"experiment_id"=>"","title"=>$experiment_name,"description"=>$experiment_description,"creation_date"=>date("Y-m-d H:i:s"),"last_edit_date"=>date("Y-m-d H:i:s"),"process_state"=>"empty","used_plaza_database"=>$data_source));
      
	$this->redirect(array("controller"=>"trapid","action"=>"experiments"));	
      }
      else{
      	$this->set("error","Please enter the necessary information in the required fields");
	return;
      }
    }   
  }





  /*
   * Content page of a single experiment
   * Data displayed here should consist of basic information.
   * More complicated info (which would require more processing)
   * should only be accesible through tool-pages
   */
  function experiment($exp_id=null){
    $exp_id	= mysql_real_escape_string($exp_id);
    parent::check_user_exp($exp_id);   
    $standard_experiment_info	= $this->Experiments->find("first",array("conditions"=>array("experiment_id"=>$exp_id)));        
    $this->TrapidUtils->checkPageAccess($standard_experiment_info['Experiments']['title'],$standard_experiment_info['Experiments']['process_state'],$this->process_states["default"]); 
    
    $this->set("exp_id",$exp_id);
    $user_group=$this->Authentication->find("first",array("fields"=>array("group"),"conditions"=>array("user_id"=>parent::check_user())));
    if($user_group['Authentication']['group'] == "admin"){$this->set("admin",1);}         

    //get default experiment information
    
    $transcript_experiment_info	= $this->Transcripts->findExperimentInformation($exp_id); 
    $datasource_info		= $this->DataSources->find("first",array("conditions"=>array("db_name"=>$standard_experiment_info["Experiments"]["used_plaza_database"])));
    $this->set("standard_experiment_info",$standard_experiment_info);
    $this->set("transcript_experiment_info",$transcript_experiment_info);
    $this->set("datasource_info",$datasource_info["DataSources"]);
    $num_transcripts	= $transcript_experiment_info[0][0]['transcript_count'];
    $this->set("num_transcripts",$num_transcripts);
    $all_subsets	= $this->TranscriptsLabels->getLabels($exp_id);
    $this->set("num_subsets",count($all_subsets));

  
    if($standard_experiment_info['Experiments']['process_state']!="empty"){
	//retrieve information for table at bottom of page
	$transcripts_p	= $this->paginate("Transcripts",array("Transcripts.experiment_id"=>$exp_id));      
	$transcript_ids	= $this->TrapidUtils->reduceArray($transcripts_p,"Transcripts","transcript_id");

	//retrieve functional annotation for the table       
	$transcripts_go	= $this->TrapidUtils->indexArray($this->TranscriptsGo->find("all",array("conditions"=>array("experiment_id"=>$exp_id,"transcript_id"=>$transcript_ids,"is_hidden"=>"0"))),"TranscriptsGo","transcript_id","go");
	$go_info	= array();
	if(count($transcripts_go)!=0){
		$go_ids		=  array_unique(call_user_func_array("array_merge",array_values($transcripts_go)));  
		$go_info        = $this->ExtendedGo->retrieveGoInformation($go_ids);       
	}

	$transcripts_ipr= $this->TrapidUtils->indexArray($this->TranscriptsInterpro->find("all",array("conditions"=>array("experiment_id"=>$exp_id,"transcript_id"=>$transcript_ids))),"TranscriptsInterpro","transcript_id","interpro");
	$ipr_info	= array();
	if(count($transcripts_ipr)!=0){
		$ipr_ids        = array_unique(call_user_func_array("array_merge",array_values($transcripts_ipr))); 
		$ipr_info	= $this->ProteinMotifs->retrieveInterproInformation($ipr_ids);
	}

	//retrieve subset/label information
	$transcripts_labels	= $this->TrapidUtils->indexArray($this->TranscriptsLabels->find("all",array("conditions"=>array("experiment_id"=>$exp_id,"transcript_id"=>$transcript_ids))),"TranscriptsLabels","transcript_id","label");
	

	$this->set("transcript_data",$transcripts_p);
	$this->set("transcripts_go",$transcripts_go);
	$this->set("transcripts_ipr",$transcripts_ipr);
	$this->set("transcripts_labels",$transcripts_labels);
	$this->set("go_info",$go_info);
	$this->set("ipr_info",$ipr_info);
    }
  }




  function change_transcript_gf($exp_id=null,$transcript_id=null){
    if(!$exp_id || !$transcript_id){$this->redirect(array("controller"=>"trapid","action"=>"experiments"));}
    $exp_id	= mysql_real_escape_string($exp_id);
    parent::check_user_exp($exp_id);	 
    $exp_info	= $this->Experiments->getDefaultInformation($exp_id);
    $this->set("exp_info",$exp_info);
    $this->set("exp_id",$exp_id);	   
    $this->TrapidUtils->checkPageAccess($exp_info['title'],$exp_info["process_state"],$this->process_states["default"]); 

    //check whether transcript is valid
    $transcript_id 	= mysql_real_escape_string($transcript_id);
    $transcript_info    = $this->Transcripts->find("first",array("conditions"=>array("experiment_id"=>$exp_id,"transcript_id"=>$transcript_id)));
    //pr($transcript_info);
    if(!$transcript_info){$this->redirect(array("controller"=>"trapid","action"=>"experiment",$exp_id));}    	

    $this->set("transcript_info",$transcript_info);	

  }




  function similarity_hits($exp_id=null,$transcript_id=null){
    Configure::write("debug",2);
    if(!$exp_id || !$transcript_id){$this->redirect(array("controller"=>"trapid","action"=>"experiments"));}
    $exp_id	= mysql_real_escape_string($exp_id);
    parent::check_user_exp($exp_id);	 
    $exp_info	= $this->Experiments->getDefaultInformation($exp_id);
    $this->set("exp_info",$exp_info);
    $this->set("exp_id",$exp_id);	   
    $this->TrapidUtils->checkPageAccess($exp_info['title'],$exp_info["process_state"],$this->process_states["default"]); 
    //check whether transcript is valid
    $transcript_id 	= mysql_real_escape_string($transcript_id);
    $transcript_info    = $this->Transcripts->find("first",array("conditions"=>array("experiment_id"=>$exp_id,"transcript_id"=>$transcript_id)));    
    if(!$transcript_info){$this->redirect(array("controller"=>"trapid","action"=>"experiment",$exp_id));}    	
    $this->set("transcript_info",$transcript_info['Transcripts']);
    //get the similarity search hits for this transcript
    $similarity_hits   = $this->Similarities->find("first",array("conditions"=>array("experiment_id"=>$exp_id,"transcript_id"=>$transcript_id)));       
    $similarity_hits	= explode(";",$similarity_hits['Similarities']['similarity_data']);
    $sim_hits		= array();
    $gene_ids		= array();
    //get the gene identifiers.
    foreach($similarity_hits as $sh){
      $t		= explode(",",$sh);
      $gene_id		= $t[0];
      $gene_ids[] 	= $gene_id;
      $sim_hits[$gene_id][]	= $t;	
    }
    $gene_ids		= array_unique($gene_ids);
    $gf_ids		= array();
    //ok, now see whether the experiment is HOM or IORTHO. If IORTHO, don't do anything.  
    if($exp_info['genefamily_type']=="HOM"){
      $gf_prefix	= $this->DataSources->find("first",array("conditions"=>array("name"=>$exp_info['datasource'])));
      $gf_prefix	= $gf_prefix['DataSources']['gf_prefix'];       
      if($gf_prefix){$gf_ids=$this->GfData->find("all",array("conditions"=>array("gene_id"=>$gene_ids,"`gf_id` LIKE '".$gf_prefix."%'")));}
      else{$gf_ids=$this->GfData->find("all",array("conditions"=>array("gene_id"=>$gene_ids)));}    
      $gf_ids		= $this->TrapidUtils->indexArraySimple($gf_ids,"GfData","gene_id","gf_id");
      $plaza_gf_ids	= array_unique(array_values($gf_ids));    
      $plaza_gf_counts  = $this->GfData->getGeneCount($plaza_gf_ids);
      $transcript_gfs	= $this->GeneFamilies->find("all",array("conditions"=>array("plaza_gf_id"=>$plaza_gf_ids))); 
      $transcript_gfs1	= $this->TrapidUtils->indexArraySimple($transcript_gfs,"GeneFamilies","plaza_gf_id","gf_id");
      $transcript_gfs2 	= $this->TrapidUtils->indexArraySimple($transcript_gfs,"GeneFamilies","gf_id","num_transcripts");
      $this->set("plaza_gf_counts",$plaza_gf_counts);
      $this->set("transcript_gfs1",$transcript_gfs1);
      $this->set("transcript_gfs2",$transcript_gfs2);
    }
    $this->set("sim_hits",$sim_hits);
    $this->set("gf_ids",$gf_ids);

    if($this->Session->check("error")){$this->set("error",$this->Session->read("error"));$this->Session->delete("error");}
    if($this->Session->check("message")){$this->set("message",$this->Session->read("message"));$this->Session->delete("message");}
    


    if($_POST && array_key_exists("plaza_gf_id",$_POST)){     
                    
      $new_plaza_gf_id		= mysql_real_escape_string($_POST['plaza_gf_id']);
      //check if exists. If not, return to page with error message.
      $num_plaza_genes		= $this->GfData->find("count",array("conditions"=>array("gf_id"=>$new_plaza_gf_id)));
      if($num_plaza_genes==0){$this->set("error","Illegal external identifier for gene family");}
      $new_trapid_gf_id		= null;
      $new_trapid_gf_info	= null;
      $total_new_gf		= true;
      if(array_key_exists("trapid_gf_id",$_POST)){
	$new_trapid_gf_id	= mysql_real_escape_string($_POST['trapid_gf_id']);
	$new_trapid_gf_info	= $this->GeneFamilies->find("first",array("conditions"=>array("gf_id"=>$new_trapid_gf_id)));
	if(!$new_trapid_gf_info){$this->set("error","Illegal internal gene family identifier");return;}
	$total_new_gf		= false;
      }
      

      //Total new gene family:
      // - create new gf id (prefix is experiment id, suffix is plaza gf id)
      // - add gene family
      // - update transcript gene family association
      if($total_new_gf){
	$new_trapid_gf_id	= $exp_id."_".$new_plaza_gf_id;
	$this->GeneFamilies->save(array("experiment_id"=>$exp_id,"gf_id"=>$new_trapid_gf_id,"plaza_gf_id"=>$new_plaza_gf_id,"num_transcripts"=>"1"));
	$this->Transcripts->updateAll(array("gf_id"=>"'".$new_trapid_gf_id."'"),array("experiment_id"=>$exp_id,"transcript_id"=>$transcript_id));	
      }
      //
      else{
	//update the new gf id, so the number of associated transcripts is higher
        $this->GeneFamilies->updateAll(array("num_transcripts"=>"'".($new_trapid_gf_info['GeneFamilies']['num_transcripts']+1)."'","used_species"=>NULL,"exclude_transcripts"=>NULL,"msa"=>NULL,"msa_stripped"=>NULL,"msa_stripped_params"=>NULL,"tree"=>NULL),array("experiment_id"=>$exp_id,"gf_id"=>$new_trapid_gf_id));
	$this->Transcripts->updateAll(array("gf_id"=>"'".$new_trapid_gf_id."'"),array("experiment_id"=>$exp_id,"transcript_id"=>$transcript_id));
      }
      //process the old gene family of the transcript: reduce the number of associated genes with 1
      //if it reaches 0, remove the entry from the database.   							         
      $prev_gf_id			= $transcript_info['Transcripts']['gf_id'];
      $prev_transcript_count		= $this->GeneFamilies->find("first",array("conditions"=>array("experiment_id"=>$exp_id,"gf_id"=>$prev_gf_id),"fields"=>array("num_transcripts")));
      $prev_transcript_count		= $prev_transcript_count['GeneFamilies']['num_transcripts'];
      $prev_transcript_count--;	

      if($prev_transcript_count==0){	//delete this entry
	$this->GeneFamilies->deleteAll(array("experiment_id"=>$exp_id,"gf_id"=>$prev_gf_id));
      }
      else{
     	$this->GeneFamilies->updateAll(array("num_transcripts"=>"'".$prev_transcript_count."'","used_species"=>NULL,"exclude_transcripts"=>NULL,"msa"=>NULL,"msa_stripped"=>NULL,"msa_stripped_params"=>NULL,"tree"=>NULL),array("experiment_id"=>$exp_id,"gf_id"=>$prev_gf_id));
      }

      //now, also execute a short java which should 
      //a) move the functional annotation, or in cas of 'total new gf', create one from scratch
      //b) perform meta-annotation again for the newly assigned transcript.
      //these are all steps of the initial processing pipeline, but should now be performed only for a given transcript/gene family association.   
      $qsub_file  = $this->TrapidUtils->create_qsub_script($exp_id);
      $shell_file =$this->TrapidUtils->create_shell_script_data_update_gf($exp_id,$exp_info['used_plaza_database'],$new_trapid_gf_id,$transcript_id,$total_new_gf);            
      if($shell_file == null || $qsub_file == null ){
	$this->Session->write("error","Problem creating program files. Functional annotation synchronization not performed.");
	//$this->set("error","problem creating program files. Functional annotation synchronization not performed.")
      }
      else{
	  //ok, now we submit this program to the web-cluster
	  $tmp_dir	= TMP."experiment_data/".$exp_id."/";
	  $qsub_out	= $tmp_dir."gf_change_".$exp_id."_".$transcript_id."_".$new_trapid_gf_id.".out";
	  $qsub_err	= $tmp_dir."gf_change_".$exp_id."_".$transcript_id."_".$new_trapid_gf_id.".err";
	  if(file_exists($qsub_out)){unlink($qsub_out);}
	  if(file_exists($qsub_err)){unlink($qsub_err);}
	  $command  = "sh $qsub_file -q long -o $qsub_out -e $qsub_err $shell_file";
	  exec($command);     
	  $this->Session->write("message","Synchronizing functional and meta annotation with new gene family.");
      }
      $this->redirect(array("controller"=>"trapid","action"=>"similarity_hits",$exp_id,$transcript_id));
	
    }


  }



  /******************************************************************************************************
   *
   * DATA TYPE PAGES :
   *
   ******************************************************************************************************
   */



  function detect_orfs($exp_id=null,$transcript_id=null){
    $this->layout = "";
    if(!$exp_id || !$transcript_id){$this->redirect(array("controller"=>"trapid","action"=>"experiments"));}
    $exp_id	= mysql_real_escape_string($exp_id);
    parent::check_user_exp($exp_id);	 
    $exp_info	= $this->Experiments->getDefaultInformation($exp_id);
    $this->set("exp_info",$exp_info);
    $this->set("exp_id",$exp_id);	   
    $this->TrapidUtils->checkPageAccess($exp_info['title'],$exp_info["process_state"],$this->process_states["default"]); 

    //check whether transcript is valid
    $transcript_id 	= mysql_real_escape_string($transcript_id);
    $transcript_info    = $this->Transcripts->find("first",array("conditions"=>array("experiment_id"=>$exp_id,"transcript_id"=>$transcript_id)));
    //pr($transcript_info);
    if(!$transcript_info){$this->redirect(array("controller"=>"trapid","action"=>"experiment",$exp_id));}    



  }


  function transcript($exp_id=null,$transcript_id=null){
    
    if(!$exp_id || !$transcript_id){$this->redirect(array("controller"=>"trapid","action"=>"experiments"));}
    $exp_id	= mysql_real_escape_string($exp_id);
    parent::check_user_exp($exp_id);	 
    $exp_info	= $this->Experiments->getDefaultInformation($exp_id);
    $this->set("exp_info",$exp_info);
    $this->set("exp_id",$exp_id);	   
    $this->TrapidUtils->checkPageAccess($exp_info['title'],$exp_info["process_state"],$this->process_states["default"]); 

    //check whether transcript is valid
    $transcript_id 	= mysql_real_escape_string($transcript_id);
    $transcript_info    = $this->Transcripts->find("first",array("conditions"=>array("experiment_id"=>$exp_id,"transcript_id"=>$transcript_id)));
    //pr($transcript_info);
    if(!$transcript_info){$this->redirect(array("controller"=>"trapid","action"=>"experiment",$exp_id));}    


    //CHANGES TO THE INITIAL DATA. SOME OTHER POST_PROCESSING STEPS MIGHT BE NECESSARY!
    //put it here, as it might influence the later results. Also reload the transcript info
    if($_POST){      
      if(array_key_exists("orf_sequence",$_POST)){       
	$this->Transcripts->updateAll(array("orf_sequence"=>"'".mysql_real_escape_string($_POST['orf_sequence'])."'"),array("experiment_id"=>$exp_id,"transcript_id"=>$transcript_id));
	$this->Transcripts->updateCodonStats($exp_id,$transcript_id,$_POST['orf_sequence']);
      }
      if(array_key_exists("transcript_sequence",$_POST)){
	$this->Transcripts->updateAll(array("transcript_sequence"=>"'".mysql_real_escape_string($_POST['transcript_sequence'])."'"),array("experiment_id"=>$exp_id,"transcript_id"=>$transcript_id));
      }
      if(array_key_exists("corrected_sequence",$_POST)){
	$this->Transcripts->updateAll(array("transcript_sequence_corrected"=>"'".mysql_real_escape_string($_POST['corrected_sequence'])."'"),array("experiment_id"=>$exp_id,"transcript_id"=>$transcript_id));
      }
      if(array_key_exists("meta_annotation",$_POST)){
	$this->Transcripts->updateAll(array("meta_annotation"=>"'".mysql_real_escape_string($_POST['meta_annotation'])."'"),array("experiment_id"=>$exp_id,"transcript_id"=>$transcript_id));
      }
      //update edit data of the experiment!
      $this->Experiments->updateAll(array("last_edit_date"=>"'".date("Y-m-d H:i:s")."'"),array("experiment_id"=>$exp_id));
      $transcript_info = $this->Transcripts->find("first",array("conditions"=>array("experiment_id"=>$exp_id,"transcript_id"=>$transcript_id)));
    }



    $this->set("transcript_info",$transcript_info['Transcripts']);
    //pr($transcript_info['Transcripts']);
    //go and interpro information
    $associated_go	= $this->TranscriptsGo->find("all",array("conditions"=>array("experiment_id"=>$exp_id,"transcript_id"=>$transcript_id)));    
    $go_ids		= $this->TrapidUtils->reduceArray($associated_go,"TranscriptsGo","go");
    //TODO!!
    $go_information	= $this->ExtendedGo->retrieveGoInformation($go_ids);
    $this->set("associated_go",$associated_go);
    $this->set("go_info",$go_information);	

    $associated_interpro	= $this->TranscriptsInterpro->find("all",array("conditions"=>array("experiment_id"=>$exp_id,"transcript_id"=>$transcript_id)));    
    $interpros	= $this->TrapidUtils->reduceArray($associated_interpro,"TranscriptsInterpro","interpro");
    $interpro_information = $this->ProteinMotifs->retrieveInterproInformation($interpros);
    $this->set("associated_interpro",$associated_interpro);
    $this->set("interpro_info",$interpro_information);


   

  }
 

  /*
   * TODO further implement method, and take care in the possible parameters data structure to also indicate the 
   * necessary joins and required tables. 
   */
  function transcript_selection(){
    $num_parameters	= func_num_args();
    if($num_parameters < 3 || $num_parameters%2==0 ){$this->redirect("/");}
    $parameters		= func_get_args();
    $exp_id		= mysql_real_escape_string($parameters[0]);
    parent::check_user_exp($exp_id);	
    $exp_info	= $this->Experiments->getDefaultInformation($exp_id); 
    $this->TrapidUtils->checkPageAccess($exp_info['title'],$exp_info["process_state"],$this->process_states["default"]);
    $this->set("exp_info",$exp_info);
    $this->set("exp_id",$exp_id);

    foreach($parameters as $k=>$v){
      if($v=="go"){$parameters[$k+1] = str_replace("-",":",$parameters[$k+1]);	}
    }    
   
    $download_type		= null;
    $available_download_types	= array("table","fasta_transcript","fasta_orf");
    if($_POST){
      if(array_key_exists("download_type",$_POST) && in_array($_POST['download_type'],$available_download_types)){
	$download_type		= $_POST["download_type"];
      }
    }
       
    //if download, get all of the transcripts.
    if($download_type!=null){
      $this->layout = "";
      $this->set("download_type",$download_type);
      $this->paginate['TranscriptsPagination']['limit'] = $exp_info['transcript_count'];
    }    
         
    // pr("bla");
    //ok, now retrieve the transcripts
    $transcript_ids	= $this->paginate("TranscriptsPagination",$parameters);	     
    //pr($transcript_ids);      
    //pr("bla2");
    $transcripts	= $this->Transcripts->find("all",array("conditions"=>array("experiment_id"=>$exp_id,"transcript_id"=>$transcript_ids)));	
     $this->set("transcript_data",$transcripts);
    //if there is a download option, we should see now whether or not extra data retrieval is necessary.
     if($download_type=="fasta_transcript"){$this->set("file_name","transcripts_".implode("_",$parameters).".fasta");return;}
     if($download_type=="fasta_orf"){$this->set("file_name","orf_".implode("_",$parameters).".fasta");return;}
      
    
    $parsed_parameters	= $this->TranscriptsPagination->getParsedParameters($parameters);    
     //retrieve functional annotation for the table       
    $transcripts_go	= $this->TrapidUtils->indexArray($this->TranscriptsGo->find("all",array("conditions"=>array("experiment_id"=>$exp_id,"transcript_id"=>$transcript_ids,"is_hidden"=>"0"))),"TranscriptsGo","transcript_id","go");
    $go_info	= array();
    if(count($transcripts_go)!=0){
	    $go_ids		=  array_unique(call_user_func_array("array_merge",array_values($transcripts_go)));  
	    $go_info        = $this->ExtendedGo->retrieveGoInformation($go_ids);       
    }

    $transcripts_ipr= $this->TrapidUtils->indexArray($this->TranscriptsInterpro->find("all",array("conditions"=>array("experiment_id"=>$exp_id,"transcript_id"=>$transcript_ids))),"TranscriptsInterpro","transcript_id","interpro");
    $ipr_info	= array();
    if(count($transcripts_ipr)!=0){
	    $ipr_ids        = array_unique(call_user_func_array("array_merge",array_values($transcripts_ipr))); 
	    $ipr_info	= $this->ProteinMotifs->retrieveInterproInformation($ipr_ids);
    }

    //retrieve subset/label information
    $transcripts_labels	= $this->TrapidUtils->indexArray($this->TranscriptsLabels->find("all",array("conditions"=>array("experiment_id"=>$exp_id,"transcript_id"=>$transcript_ids))),"TranscriptsLabels","transcript_id","label");

	
    $this->set("parameters",$parsed_parameters);   
    $this->set("transcripts_go",$transcripts_go);
    $this->set("transcripts_ipr",$transcripts_ipr);
    $this->set("transcripts_labels",$transcripts_labels);
    $this->set("go_info_transcripts",$go_info);
    $this->set("ipr_info_transcripts",$ipr_info);	

    if($download_type=="table"){$this->set("file_name","table_".implode("_",$parameters).".txt");return;}
	    

  }



  /******************************************************************************************************
   *
   * SEARCH RESULT PAGES :
   *
   ******************************************************************************************************
   */



  function search($exp_id=null){
    $exp_id	= mysql_real_escape_string($exp_id);
    parent::check_user_exp($exp_id);	
    $exp_info	= $this->Experiments->getDefaultInformation($exp_id); 
    $this->TrapidUtils->checkPageAccess($exp_info['title'],$exp_info["process_state"],$this->process_states["default"]);       
    $this->set("exp_info",$exp_info);
    $this->set("exp_id",$exp_id);
    if(!$_POST){$this->redirect(array("controller"=>"trapid","action"=>"experiment",$exp_id));}	
    if(!array_key_exists("search_type",$_POST) || !array_key_exists("search_value",$_POST)){$this->redirect(array("controller"=>"trapid","action"=>"experiment",$exp_id));}	
    $st	= trim(mysql_real_escape_string($_POST['search_type']));
    $sv = trim(mysql_real_escape_string($_POST['search_value']));

    $this->set("search_type",$st);
    $this->set("search_value",$sv);
    if(strlen($sv)==0){$this->set("search_result","bad_search");return;}  

    if($st=="transcript"){    
      $transcripts_info	= $this->Transcripts->find("count",array("conditions"=>array("experiment_id"=>$exp_id,"transcript_id"=>$sv))); 
      if(!$transcripts_info){$this->set("search_result","bad_search");return;}      
      else{$this->redirect(array("controller"=>"trapid","action"=>"transcript",$exp_id,urlencode($sv)));}
    }
    else if($st=="gf"){
      $transcripts_info = $this->GeneFamilies->find("count",array("conditions"=>array("experiment_id"=>$exp_id,"gf_id"=>$sv)));
      if(!$transcripts_info){$this->set("search_result","bad_search");return;}
      else{$this->redirect(array("controller"=>"gene_family","action"=>"gene_family",$exp_id,urlencode($sv)));}
    }
    else if($st=="GO"){
      //check on length of search value.
      if(strlen($sv) < 4){$this->set("search_result","bad_search");return;}
      //find GO terms with this description
      $go_terms	= $this->ExtendedGo->find("all",array("conditions"=>array("`ExtendedGo.desc` LIKE '%$sv%'")));
      if(!$go_terms){$this->set("search_result","bad_search");$this->set("error","Unknown GO description");return;}
      $go_terms = $this->TrapidUtils->indexArraySimple($go_terms,"ExtendedGo","go","desc");    
      //ok, now find possible associated transcripts
      $transcripts_info = $this->TranscriptsGo->findTranscriptsFromGo($exp_id,$go_terms);
      if(!$transcripts_info){$this->set("search_result","bad_search");return;}
      $this->set("transcripts_info",$transcripts_info);
      $this->set("search_result","go");
      return;
    }
    else if($st=="interpro"){
      //check on length of search value
      if(strlen($sv) < 4){$this->set("search_result","bad_search");return;}
      //find InterPro domains with this description       
      $ipr_terms = $this->ProteinMotifs->find("all",array("conditions"=>array("`ProteinMotifs.desc` LIKE '%$sv%' ")));
      if(!$ipr_terms){$this->set("search_result","bad_search");$this->set("error","Unknown InterPro description");return;}
      $ipr_terms = $this->TrapidUtils->indexArraySimple($ipr_terms,"ProteinMotifs","motif_id","desc");
      //ok, now find possibe associated transcripts
      $transcripts_info = $this->TranscriptsInterpro->findTranscriptsFromInterpro($exp_id,$ipr_terms);
      if(!$transcripts_info){$this->set("search_result","bad_search");return;}
      $this->set("transcripts_info",$transcripts_info);
      $this->set("search_result","interpro");
      return;
    }
    else if($st=="meta_annotation"){
      if(!($sv=="No Information" || $sv=="Partial" || $sv=="Full Length")){$this->set("search_result","bad_search");return;}
      $this->redirect(array("controller"=>"trapid","action"=>"transcript_selection",$exp_id,"meta_annotation",urlencode($sv)));
    }
    else{
      $this->redirect(array("controller"=>"trapid","action"=>"experiment",$exp_id));
    }	
  }



  /*******************************************************************************************************
   *
   *  DATA PROCESSING
   * 
   ********************************************************************************************************/

  function initial_processing($exp_id=null){   
    $exp_id	= mysql_real_escape_string($exp_id);
    parent::check_user_exp($exp_id);	
    $exp_info	= $this->Experiments->getDefaultInformation($exp_id); 
    $user_group=$this->Authentication->find("first",array("fields"=>array("group"),"conditions"=>array("user_id"=>parent::check_user())));
    if($user_group['Authentication']['group'] != "admin"){
      $this->TrapidUtils->checkPageAccess($exp_info['title'],$exp_info["process_state"],$this->process_states["upload"]);       
    }
    $this->set("exp_info",$exp_info);
    $this->set("exp_id",$exp_id);
  
    $possible_db_types	= array("SINGLE_SPECIES"=>"Single Species","CLADE"=>"Phylogenetic Clade","GF_REP"=>"Gene Family Representatives");
    $possible_gf_types	= array("HOM"=>"Tribe/Ortho MCL clusters","IORTHO"=>"Integrative Orthology");    		 
    
    //retrieve species information for BLAST info   
    $species_info = $this->AnnotSources->getSpeciesCommonNames();    
    $data_sources = $this->DataSources->find("first",array("conditions"=>array("db_name"=>$exp_info["used_plaza_database"])));     
    $clades	= $this->TrapidUtils->valueToIndexArray(explode(";",$data_sources["DataSources"]["clades"]));	
    ksort($clades);           
    $species_info	= $this->TrapidUtils->checkAvailableRapsearchDB($exp_info['used_plaza_database'],$species_info);
    $clades		= $this->TrapidUtils->checkAvailableRapsearchDB($exp_info['used_plaza_database'],$clades);
    $gf_representatives	= $this->TrapidUtils->checkAvailableRapsearchDB($exp_info['used_plaza_database'],array("gf_representatives"=>"Genefamily representatives"));     
 
    $this->set("available_species",$species_info);   
    $this->set("clades_species",$clades);
    $this->set("gf_representatives",$gf_representatives);
    if(count($species_info)==0){$this->set("error","No valid species databases found. Please contact webadmin");}
    if(count($clades)==0 && count($species_info)>0){$this->set("error","No valid clades databases found. Please contact webadmin");}    
    if(count($species_info)==0){unset($possible_db_types["SINGLE_SPECIES"]);}
    if(count($clades)==0){unset($possible_db_types["CLADE"]);}
    if(count($gf_representatives)==0){unset($possible_db_types["GF_REP"]);}

    //pr($possible_db_types);

    //retrieve information for the gene family type
    if($data_sources['DataSources']['gf']==0){unset($possible_gf_types['HOM']);}
    if($data_sources['DataSources']['iortho']==0){unset($possible_gf_types['IORTHO']);}

    $this->set("possible_db_types",$possible_db_types);
    $this->set("possible_gf_types",$possible_gf_types);	  

    //possible e-values
    $possible_evalues	= array("10e-2"=>"-2","10e-3"=>"-3","10e-4"=>"-4",
				"10e-5"=>"-5","10e-6"=>"-6","10e-7"=>"-7",
				"10e-8"=>"-8","10e-9"=>"-9","10e-10"=>"-10");
    $this->set("possible_evalues",$possible_evalues);

    if($_POST){	      
      //pr($_POST);
      //parameter checking.
      if(!(array_key_exists("blast_db_type",$_POST) && array_key_exists("blast_db",$_POST)
	   && array_key_exists("blast_evalue",$_POST) && array_key_exists("gf_type",$_POST))){
	$this->set("error","Incorrect parameters : missing parameters");return;
      }                  
      $num_blast_hits	= 1;
      $blast_db_type 	= mysql_real_escape_string($_POST['blast_db_type']);
      $blast_db		= mysql_real_escape_string($_POST['blast_db']);
      $blast_evalue	= mysql_real_escape_string($_POST['blast_evalue']);
      $gf_type		= mysql_real_escape_string($_POST['gf_type']);
      $used_blast_desc	= "";	
      if(!(array_key_exists($blast_db_type,$possible_db_types) && 
	  array_key_exists($gf_type,$possible_gf_types) && 
	   array_key_exists($blast_evalue,$possible_evalues))){
	$this->set("error","Incorrect parameters: faulty parameters");return;
      }	     
      if($blast_db_type=="SINGLE_SPECIES"){
	if(!array_key_exists($blast_db,$species_info)){$this->set("error","Incorrect parameters: unknown species - ".$blast_db);return;}
	else{$used_blast_desc = $species_info[$blast_db];}
      }      
      if($blast_db_type=="CLADE"){
	if(!array_key_exists($blast_db,$clades)){$this->set("error","Incorrect parameters : unknown clade - ".$blast_db);return;}
	else{$used_blast_desc = $clades[$blast_db];}
      }
      if($blast_db_type=="GF_REP"){
	if($blast_db!="gf_representatives"){$this->set("error","Incorrect parameters : wrong GF_REP DB - ".$blast_db);return;}       
      }
      if($gf_type=="IORTHO" && $blast_db_type!="SINGLE_SPECIES"){
	$this->set("error","Incorrect parameters : IORTHO conflict");return;
      }

      if($blast_db_type=="SINGLE_SPECIES"){$num_blast_hits=1;}
      else if($blast_db_type=="CLADE"){$num_blast_hits=1;}
      else if($blast_db_type=="GF_REP"){$num_blast_hits=5;}
       
    
      //pr($_POST);
      //return;


      //parameters are ok. we can now proceed with the actual pipeline organization.    
      //create shell file for submission to the web-cluster.
      //Shell file contains both the necessary module load statements
      //as well as the correct name for the global perl-file.
      //A single "initial processing" job should only run on a single cluster-node   
      $qsub_file  = $this->TrapidUtils->create_qsub_script($exp_id);     
      $shell_file = $this->TrapidUtils->create_shell_file_initial($exp_id,$exp_info['used_plaza_database'],$blast_db,$gf_type,$num_blast_hits,$possible_evalues[$blast_evalue]);
      if($shell_file == null || $qsub_file == null ){$this->set("error","problem creating program files");return;}	          
     
      //ok, now we submit this program to the web-cluster
      $tmp_dir	= TMP."experiment_data/".$exp_id."/";
      $qsub_out	= $tmp_dir."initial_processing.out";
      $qsub_err	= $tmp_dir."initial_processing.err";     
      if(file_exists($qsub_out)){unlink($qsub_out);}
      if(file_exists($qsub_err)){unlink($qsub_err);}

      $command  = "sh $qsub_file -q long -o $qsub_out -e $qsub_err $shell_file";
      exec($command);     

      //indicate in the database that the current experiment is "busy", and should as such not be accesible.
      $this->Experiments->updateAll(array("process_state"=>"'processing'","genefamily_type"=>"'".$gf_type."'","last_edit_date"=>"'".date("Y-m-d H:i:s")."'","used_blast_database"=>"'".$possible_db_types[$blast_db_type]."/".$used_blast_desc."'"),array("experiment_id"=>$exp_id));      
      if($gf_type=="IORTHO"){
	$this->Experiments->updateAll(array("target_species"=>"'".$blast_db."'"),array("experiment_id"=>$exp_id));
      }

      //finally, redirect
      $this->redirect(array("controller"=>"trapid","action"=>"experiments"));
    }   
  }









  /*******************************************************************************************************
   *
   *  DATA IMPORT / EXPORT
   * 
   ********************************************************************************************************/

  /**
   * Function to import transcript-data. Either multi-fasta files (normal) or zipped files.
   * For zipped files, we apply some extra tests to see whether we're not dealing with a zip-bomb.
   */
  function import_data($exp_id=null){
    $exp_id	= mysql_real_escape_string($exp_id);
    parent::check_user_exp($exp_id);
    $exp_info	= $this->Experiments->getDefaultInformation($exp_id);
    $this->TrapidUtils->checkPageAccess($exp_info['title'],$exp_info["process_state"],$this->process_states["start"]);       
    $this->set("exp_info",$exp_info);
    $this->set("exp_id",$exp_id);

    //this is a basis location for creating the temp storage for an experiment.
    $tmp_dir	= TMP."experiment_data/".$exp_id."/";	
    if(!file_exists($tmp_dir) || !is_dir($tmp_dir)){
	mkdir($tmp_dir,0777);
	shell_exec("chmod a+w $tmp_dir");
    }

    //pr($_SERVER);
    //return;
		
    //pr(fileperms($tmp_dir));
    //pr(fileperms(TMP."experiment_data/"));
    //shell_exec("chmod a+w $tmp_dir");
    	
    

    if($_POST){

      //pr($_POST);
      //pr($_FILES);
      //pr(ini_get('upload_max_filesize'));
      //pr($_POST);
      //return;
        set_time_limit(180);       

	$MAX_FILE_SIZE_NORMAL		= 32000000;
	$MAX_FILE_SIZE_ZIP		= 32000000;
	$MAX_FILE_SIZE_ZIP_EXPANDED	= 100000000;

        //check uploaded file
      	if(!isset($_FILES["uploadedfile"])){$this->redirect(array("controller"=>"trapid","action"=>"experiments"));}	       		
	if(($_FILES['uploadedfile']['name']=="")){$this->set("error","Illegal input file (no name)");return;}
	if(($_FILES['uploadedfile']['size'] == 0)){$this->set("error","Illegal input file (size is 0)");return;}
	if(($_FILES['uploadedfile']['tmp_name'] == "")){$this->set("error","Illegal input file (no tmp_name)");return;}
      			
	$myFile 		= $_FILES['uploadedfile']['tmp_name'];
	$filename		= $_FILES['uploadedfile']['name'];		
	
	//find file-extension of filename, and based on this decided what to do with it.
        $filename_d		= explode(".",$filename);
	$file_extension		= $filename_d[count($filename_d)-1];
	$normal_fasta_file	= true;
        if($file_extension=="fasta"||$file_extension=="tfa"||$file_extension=="fa"){$normal_fasta_file=true;}
	else if($file_extension=="zip"||$file_extension=="gz"){$normal_fasta_file = false;}
	else{
	  $this->set("error","Illegal file-name. Only allowed file-extensions: 'fasta','fa','tfa' (normal) ,'zip','gz' (compressed)");
	  return;
	}
	
	$transcripts		= array();
	$delete_temp_file	= false;
	if($normal_fasta_file){
	  //check on file size
	  if($_FILES['uploadedfile']['size']>$MAX_FILE_SIZE_NORMAL){$this->set("error","File is too large");return;}    
	  //copy file to upload directory
	  shell_exec("cp ".$myFile." ".$tmp_dir."uploaded.fasta");
	  $myFile = $tmp_dir."uploaded.fasta";
	  $delete_temp_file = true;
	}
	else{
	  //check on file size
	  if($_FILES['uploadedfile']['size']>$MAX_FILE_SIZE_ZIP){$this->set("error","File is too large");return;}	 	  
	  if($file_extension=="gz"){
	    //check uncompressed file size
	    $file_info	= explode("\n",shell_exec("gzip -l ".$myFile));	   
	    if(count($file_info)<2){$this->set("error","Corrupt archive");return;}	    
	    $file_info	= explode(" ",$file_info[1]);
	    $fi	= array();
	    foreach($file_info as $f){if($f!=""){$fi[]=$f;}}
	    if($f[1]>$MAX_FILE_SIZE_ZIP_EXPANDED){$this->set("error","Uncompressed file is too large");return;}			    
	    //extract file	   
	    shell_exec("gunzip -c ".$myFile." > ".$tmp_dir."unzipped.fasta");	  
	    $myFile = $tmp_dir."unzipped.fasta";  
	    $delete_temp_file = true;	    
	  }
	  if($file_extension=="zip"){
	    //check uncompressed file size
	    $file_info	= explode("\n",shell_exec("zipinfo ".$myFile));		  	   
	    if(count($file_info)>4){$this->set("error","Corrupt archive");return;}
	    $file_info = explode(",",$file_info[2]);
	    $file_info = explode(" ",$file_info[1]);
	    $file_size = $file_info[1];
	    if($file_size>$MAX_FILE_SIZE_ZIP_EXPANDED){$this->set("error","Uncompressed file is too large");return;}
	    //extract file	  
	    shell_exec("unzip -p ".$myFile." > ".$tmp_dir."unzipped.fasta");
	    $myFile = $tmp_dir."unzipped.fasta";
	    $delete_temp_file = true;
	  }		
	}	
	
	//right, now we should have a multi-fasta file, with path at $myFile.
	//we now just attempt to read it, and check whether each line is actually OK.
	//but first: dos2unix to prevent any stupid characters to give trouble
	shell_exec("dos2unix ".$myFile);
	//pr($myFile);
	//return;

        $fh 			= fopen($myFile,'r');
    	$transcripts_input	= fread($fh,filesize($myFile));   
    	$transcripts		= array();	
	fclose($fh);
         
	$tmp			= explode("\n",$transcripts_input);     	    
	//pr($tmp);
	$current_transcript	= null;
	$current_seq		= "";
	for($i=0;$i<count($tmp);$i++){
	  //pr(substr($tmp[$i],0,1)." ".$tmp[$i]);
	  if(substr($tmp[$i],0,1)==">"){	
	    //pr("ok");
	    //store previous result if necessary
	    if($current_transcript!=null){	      
	      if(count($transcripts)>1000){//reduce out of memory problems	       
		$this->Transcripts->saveAll($transcripts);
	      	$transcripts	= array();
	      }
	      $transcripts[] = array("experiment_id"=>$exp_id,"transcript_id"=>$current_transcript,"transcript_sequence"=>$current_seq);
	    }
	    //initiate new variables
	    $current_transcript = mysql_real_escape_string(trim(substr($tmp[$i],1)));
	    if(strstr($current_transcript," ")){$current_transcript=strstr($current_transcript," ",TRUE);}
	    if(strstr($current_transcript,"|")){$current_transcript=strstr($current_transcript,"|",TRUE);}	   
	    $current_seq	= "";
	    //pr($current_transcript);
	  }
	  else{
	    $current_seq	= $current_seq.(Sanitize::paranoid(trim($tmp[$i])));	
	  }
	}
	if($current_transcript!=null){
	  $transcripts[] = array("experiment_id"=>$exp_id,"transcript_id"=>$current_transcript,"transcript_sequence"=>$current_seq);	 
	}
	   	
	//store data in the database
	$this->Transcripts->saveAll($transcripts);
	//update dates and process state for the experiment
	$this->Experiments->updateAll(	array("last_edit_date"=>"'".date("Y-m-d H:i:s")."'","process_state"=>"'upload'"),
		array("experiment_id"=>$exp_id));             

	//delete temp-file if necessary
	if($delete_temp_file){
	  unlink($myFile);
	}

	//redirect to experiment
	//return;
	$this->redirect(array("controller"=>"trapid","action"=>"experiment",$exp_id));      
    }              
  }



  function import_labels($exp_id=null){
    $exp_id	= mysql_real_escape_string($exp_id);
    parent::check_user_exp($exp_id);
    $exp_info	= $this->Experiments->getDefaultInformation($exp_id);
    $this->TrapidUtils->checkPageAccess($exp_info['title'],$exp_info["process_state"],$this->process_states["default"]);       
    $this->set("exp_info",$exp_info);
    $this->set("exp_id",$exp_id);

    $MAX_FILE_SIZE_NORMAL		= 2000000;	

    if($_POST){
	if(!isset($_FILES["uploadedfile"])){$this->redirect(array("controller"=>"trapid","action"=>"experiments"));}	       		
        if(($_FILES['uploadedfile']['name']=="") || ($_FILES['uploadedfile']['size'] == 0) ||($_FILES['uploadedfile']['tmp_name'] == "")){
	  $this->set("error","Illegal input file");return;
	}
	
	if(!isset($_POST['label'])||$_POST['label']==""){$this->set("error","No label defined");return;}
	$label	= mysql_real_escape_string($_POST['label']);
	if($_FILES['uploadedfile']['size']>$MAX_FILE_SIZE_NORMAL){$this->set("error","File is too large");return;}    
	$myFile 		= $_FILES['uploadedfile']['tmp_name'];	
	$fh 			= fopen($myFile,'r');
    	$transcripts_input	= fread($fh,filesize($myFile));   
       
    	$transcripts		= preg_split("/[\s,]+/",$transcripts_input);       
	$transcripts		= array_unique($transcripts);
	fclose($fh);    
        //check correctness of both the transcripts and whether label already exists for the indicated transcripts
	$counter = $this->TranscriptsLabels->enterTranscripts($exp_id,$transcripts,$label);
        $this->set("message",$counter." transcripts have been labeled as '".$label."' ");
	return;    
    }
  }









  function export_data($exp_id=null){
    $exp_id	= mysql_real_escape_string($exp_id);
    parent::check_user_exp($exp_id);
    $exp_info	= $this->Experiments->getDefaultInformation($exp_id);
    $this->TrapidUtils->checkPageAccess($exp_info['title'],$exp_info["process_state"],$this->process_states["default"]);       
    $this->set("exp_info",$exp_info);
    $this->set("exp_id",$exp_id);	

    $structural_export = array("transcript_id"=>"Transcript identifier","frame_info"=>"Frame information","frameshift_info"=>"Frameshift information","orf"=>"ORF information","meta_annotation"=>"Meta annotation");
    $structural_export_cols = array(	"transcript_id"=>array("transcript_id"),
					"frame_info"=>array("detected_frame","detected_strand","full_frame_info"), 
					"frameshift_info"=>array("putative_frameshift","is_frame_corrected"),
					"orf"=>array("orf_start","orf_stop","orf_contains_start_codon","orf_contains_stop_codon"),
					"meta_annotation"=>array("meta_annotation","meta_annotation_score")
					);
    $this->set("structural_export",$structural_export);

    if($_POST){
      //pr($_POST);
      //return;
      if(!array_key_exists("export_type",$_POST)){return;}
      $export_type	= $_POST["export_type"];     
      $this->set("export_type",$export_type);
      if($export_type=="structural"){
	//get columns for export
	$columns	= array();	
	foreach($_POST as $k=>$v){	  
	  if(array_key_exists($k,$structural_export_cols)){foreach($structural_export_cols[$k] as $col){$columns[]=$col;}}
	}	     
	$data		= $this->Transcripts->find("all",array("conditions"=>array("experiment_id"=>$exp_id),
							       "fields"=>$columns,
						   	       "order"=>array("`transcript_id` ASC")
						   ));
	$data		= $this->TrapidUtils->unify($data);
	$this->set("columns",$columns);
        $this->set("data",$data);
	$this->set("file_name",$exp_id."_structural_data.txt");
	$this->layout = "";	
	return;
      }
      else if($export_type=="sequence"){
	if(!array_key_exists("sequence_type",$_POST)){return;}
	$sequence_type	= $_POST['sequence_type'];
	if($sequence_type=="original"){
	  $data	= $this->Transcripts->find("all",array("conditions"=>array("experiment_id"=>$exp_id),
						       "fields"=>array("transcript_id","transcript_sequence")));
	  $this->set("data",$data);
	  $this->set("column","transcript_sequence");
	  $this->set("file_name",$exp_id."_sequences_original.txt");
	  $this->layout = "";
	  return;	
	}
	else if($sequence_type=="orf"){
	  $data	= $this->Transcripts->find("all",array("conditions"=>array("experiment_id"=>$exp_id),
						       "fields"=>array("transcript_id","orf_sequence")));
	  $this->set("data",$data);
	  $this->set("column","orf_sequence");
	  $this->set("file_name",$exp_id."_sequences_orf.txt");
	  $this->layout = "";
	  return;
	}
	else if($sequence_type=="aa"){
	  $data	= $this->Transcripts->find("all",array("conditions"=>array("experiment_id"=>$exp_id),
						       "fields"=>array("transcript_id","orf_sequence")));	  
	  $this->set("data",$data);
	  $this->set("column","orf_sequence");
	  $this->set("file_name",$exp_id."_sequences_aa.txt");
	  $this->layout = "";
	  return;
	}
      }
      else if($export_type=="gf"){
	if(!array_key_exists("gf_type",$_POST)){return;}
	$gf_type	= $_POST['gf_type'];
	if($gf_type=="transcript"){
	  $data = $this->Transcripts->find("all",array("conditions"=>array("experiment_id"=>$exp_id),
						       "fields"=>array("transcript_id","gf_id")));
	  $this->set("data",$data);
	  $this->set("data_type","normal");
	  $this->set("table","Transcripts");
	  $this->set("columns",array("transcript_id","gf_id"));
	  $this->set("file_name",$exp_id."_gf_normal.txt");
	  $this->layout	= "";
	  return;	
	}
	else if($gf_type=="phylo"){
	  $data = $this->Transcripts->find("all",array("conditions"=>array("experiment_id"=>$exp_id),
						       "fields"=>array("transcript_id","gf_id")));	 
	  $this->set("data",$data);
	  $this->set("data_type","meta");
	  $this->set("table","Transcripts");
	  $this->set("main_column","gf_id");
	  $this->set("sec_column","transcript_id");
	  $this->set("file_name",$exp_id."_gf_phylo.txt");
	  $this->layout	= "";
	  return;
	}       
      }
      else if($export_type=="functional"){
	if(!array_key_exists("functional_type",$_POST)){return;}
	$functional_type	= $_POST['functional_type'];
	if($functional_type=="transcript_go"){
	  $data	= $this->TranscriptsGo->find("all",array("conditions"=>array("experiment_id"=>$exp_id),
							 "fields"=>array("transcript_id","go","is_hidden")));	 	 
	  $this->set("data",$data);
	  $this->set("data_type","normal");
	  $this->set("table","TranscriptsGo");
	  $this->set("columns",array("transcript_id","go","is_hidden"));
	  $this->set("file_name",$exp_id."_go_normal.txt");
	  $this->layout = "";
	  return;
	}
	else if($functional_type=="meta_go"){
	  $data	= $this->TranscriptsGo->find("all",array("conditions"=>array("experiment_id"=>$exp_id),
							 "fields"=>array("transcript_id","go","is_hidden")));
	  $extra_data	= $this->ExtendedGo->find("all",array("fields"=>array("go","desc")));
	  $extra_data	= $this->TrapidUtils->indexArraySimple($extra_data,"ExtendedGo","go","desc");
	  $this->set("data",$data);    
	  $this->set("extra_data",$extra_data);
	  $this->set("data_type","meta2");
	  $this->set("table","TranscriptsGo");  	 
	  $this->set("main_column","go");
	  $this->set("sec_column","transcript_id");
	  $this->set("file_name",$exp_id."_go_meta.txt");
	  $this->layout = "";
	  return;
	}
	else if($functional_type=="transcript_ipr"){
	  $data	= $this->TranscriptsInterpro->find("all",array("conditions"=>array("experiment_id"=>$exp_id),
							 "fields"=>array("transcript_id","interpro")));
	  $this->set("data",$data);
	  $this->set("data_type","normal");
	  $this->set("table","TranscriptsInterpro");
	  $this->set("columns",array("transcript_id","interpro"));
	  $this->set("file_name",$exp_id."_interpro_normal.txt");
	  $this->layout = "";
	  return;
	}
	else if($functional_type=="meta_ipr"){
	  $data	= $this->TranscriptsInterpro->find("all",array("conditions"=>array("experiment_id"=>$exp_id),
							 "fields"=>array("transcript_id","interpro")));
	  $extra_data	= $this->ProteinMotifs->find("all",array("fields"=>array("motif_id","desc")));
	  $extra_data	= $this->TrapidUtils->indexArraySimple($extra_data,"ProteinMotifs","motif_id","desc");
	  $this->set("data",$data);    
	  $this->set("extra_data",$extra_data);
	  $this->set("data_type","meta2");
	  $this->set("table","TranscriptsInterpro");  	 
	  $this->set("main_column","interpro");
	  $this->set("sec_column","transcript_id");
	  $this->set("file_name",$exp_id."_interpro_meta.txt");
	  $this->layout = "";
	  return;
	}	
      }
      else{
	return;
      }
    }
			      
  }










  function empty_experiment($exp_id=null){
    $exp_id	= mysql_real_escape_string($exp_id);
    parent::check_user_exp($exp_id);
    $exp_info	= $this->Experiments->getDefaultInformation($exp_id);
    $this->TrapidUtils->checkPageAccess($exp_info['title'],$exp_info["process_state"],$this->process_states["default"]);     
    //delete everything from all tables for this experiment
    $this->TranscriptsGo->query("DELETE FROM `TranscriptsGo` WHERE `experiment_id`='".$exp_id."'");	 
    $this->TranscriptsInterpro->query("DELETE FROM `TranscriptsInterpro` WHERE `experiment_id`='".$exp_id."'");
    $this->GeneFamilies->query("DELETE FROM `GeneFamilies` WHERE `experiment_id`='".$exp_id."'");
    $this->TranscriptsLabels->query("DELETE FROM `TranscriptsLabels` WHERE `experiment_id`='".$exp_id."'");
    $this->Transcripts->query("DELETE FROM `Transcripts` WHERE `experiment_id`='".$exp_id."'");
    $this->Similarities->query("DELETE FROM `Similarities` WHERE `experiment_id`='".$exp_id."'");
    $this->Experiments->updateAll(array("last_edit_date"=>"'".date("Y-m-d H:i:s")."'","process_state"=>"'empty'"),
		array("experiment_id"=>$exp_id));    

    //remove directory from the temp storage 
    $tmp_dir	= TMP."experiment_data/".$exp_id."/";	
    if(file_exists($tmp_dir) && is_dir($tmp_dir)){       
	shell_exec("rm -rf $tmp_dir/*");
    }	

    //redirect
    $this->redirect(array("controller"=>"trapid","action"=>"experiments"));
  }



  function delete_experiment($exp_id=null){
    $exp_id	= mysql_real_escape_string($exp_id);
    parent::check_user_exp($exp_id);
    $exp_info	= $this->Experiments->getDefaultInformation($exp_id);
    $this->TrapidUtils->checkPageAccess($exp_info['title'],$exp_info["process_state"],$this->process_states["default"]); 	
    //delete everything from all tables for this experiment	
    $this->TranscriptsGo->query("DELETE FROM `TranscriptsGo` WHERE `experiment_id`='".$exp_id."'");	 
    $this->TranscriptsInterpro->query("DELETE FROM `TranscriptsInterpro` WHERE `experiment_id`='".$exp_id."'");
    $this->GeneFamilies->query("DELETE FROM `GeneFamilies` WHERE `experiment_id`='".$exp_id."'");
    $this->TranscriptsLabels->query("DELETE FROM `TranscriptsLabels` WHERE `experiment_id`='".$exp_id."'");
    $this->Transcripts->query("DELETE FROM `Transcripts` WHERE `experiment_id`='".$exp_id."'");
    $this->Similarities->query("DELETE FROM `Similarities` WHERE `experiment_id`='".$exp_id."'");
    //remove experiment
    $this->Experiments->deleteAll(array("Experiments.experiment_id"=>$exp_id));

    //remove directory from the temp storage 
    $tmp_dir	= TMP."experiment_data/".$exp_id."/";	
    if(file_exists($tmp_dir) && is_dir($tmp_dir)){       
	shell_exec("rm -rf $tmp_dir");
    }	

    $this->redirect(array("controller"=>"trapid","action"=>"experiments"));
  }





  /*******************************************************************************************************
   *
   *  AUTHENTICATION STUFF : COOKIES ETC.
   * 
   ********************************************************************************************************/





  /*
   * Authentication: registration and login
   */
  function authentication($registration=null){          
    //basic first check, to see whether user is already logged in.
    $user_id		= $this->Cookie->read("user_id");
    $email		= $this->Cookie->read("email");
    $user_id  		= mysql_real_escape_string($user_id);
    $email		= mysql_real_escape_string($email);
    $user_data		= $this->Authentication->find("first",array("conditions"=>array("user_id"=>$user_id,"email"=>$email)));	
    if($user_data){$this->redirect(array("controller"=>"trapid","action"=>"experiments"));}

    if($registration=="registration"){
      $this->set("registration",true);
    }
    if($_POST){              
      //registration part of the page
      if(array_key_exists("registration",$_POST)){
	//standard validation of input parameters
	if(!(array_key_exists("login",$_POST)&&array_key_exists("organization",$_POST)&&array_key_exists("country",$_POST))){
	  $this->set("error","Invalid form parameters");return;
	}
	$email		= mysql_real_escape_string($_POST["login"]);
	$organization	= mysql_real_escape_string($_POST["organization"]);
	$country	= mysql_real_escape_string($_POST["country"]);
	if(!($email!="" && $organization!="" && $country!="")){
	  $this->set("error","Not all fields are filled in");return;
	}
	//check whether valid email-address, using the models validation
	$this->Authentication->set(array("email"=>$email));
	if(!$this->Authentication->validates()){
	  $this->set("error","Invalid email address");return;
	}	
	//check whether email-address is already present in authentication table of database
	$user_data	= $this->Authentication->find("first",array("conditions"=>array("email"=>$email)));
	if($user_data){
	  $this->set("error","Email-address already in use");return;
	}
	//now, we can actually create a password, add the user to the database	
	$password	= $this->TrapidUtils->rand_str(8);	 	
	$hashed_pass	= hash("sha256",$password);
	$this->Authentication->save(array("user_id"=>"","email"=>$email,"password"=>$hashed_pass,"group"=>"academic",
					  "organization"=>$organization,"country"=>$country));
	//send email to user with password information
	$this->TrapidUtils->send_registration_email($email,$password);	
	$this->set("message","Please use the authentication information send to you by email to login");
	$this->set("registration",false);
	return;       
      }

      //authentication part of the page
      else{       
	if(array_key_exists("login",$_POST) && array_key_exists("password",$_POST)){
	  $email	= mysql_real_escape_string($_POST["login"]);
	  $password	= mysql_real_escape_string(hash("sha256",$_POST["password"]));	
	  $user_data 	= $this->Authentication->find("first",array("conditions"=>array("email"=>$email,"password"=>$password)));
	  if(!$user_data){$this->set("error","Wrong email/password");return;}
	  $this->Cookie->write("user_id",$user_data['Authentication']['user_id']);
	  $this->Cookie->write("email",$user_data['Authentication']['email']);
	  $this->redirect(array("controller"=>"trapid","action"=>"experiments"));
        }
        else{$this->redirect(array("controller"=>"trapid","action"=>"authentication"));}
      }     
    }   
  }



  /*
   * Cookie setup: 
   * The entire TRAPID websit is based on user-defined data sets, and as such a method for 
   * account handling and user identification is required.
   *
   * The 'beforeFilter' method is executed BEFORE each method, and as such ensures that the necessary
   * identification through cookies is done.
   */
  function beforeFilter(){
    parent::beforeFilter();
    /* $this->set("title" ,WEBSITE_TITLE);
    $this->Cookie->name		= "trapid_cookie";
    $this->Cookie->time		= "7200";
    $this->Cookie->path		= "/webtools/trapid/";
    $this->Cookie->domain	= "bioinformatics.psb.ugent.be";
    $this->Cookie->key		= "JsjdKO09DJfdfjODWSkdW89Sd";
    $this->Cookie->secure	= false;
    */
  }


 

   /*
    * Function which deletes the stored cookies for authentication, then redirects to home-page
    */
   function log_off(){
     $this->Cookie->destroy();
     $this->redirect("/");
   }



}



?>