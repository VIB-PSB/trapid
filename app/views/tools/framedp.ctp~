<div>
<h3>Frameshift correction using FrameDP</h3>
<div class="subdiv">
	<?php echo $this->element("trapid_experiment");?>
	<h3>FrameDP</h3>
	<div class="subdiv">

		<?php if(isset($error) && $error=="framedp_state"):?>
		
		<span class="error">
		The FrameDP pre-processing step (creating models from a set of transcripts) has not finished yet.<br/>		
		Current status: <u><?php echo $exp_info['framedp_state'];?></u><br/>
		</span>
		<?php else: ?>
		<?php
		echo $form->create(null,array("action"=>"framedp/".$exp_id."/".$gf_id,"type"=>"post"));
		?>
		<dl class="standard">
			<dt>Gene family</dt>
			<dd>
				<?php echo $html->link($gf_id,array("controller"=>"gene_family","action"=>"gene_family",$exp_id,$gf_id));?>
			</dd>
			<dt>Transcripts</dt>
			<dd>	
				<div>				
				<?php	
															
				echo "<div style='float:left;width:400px;'>\n";		
				echo "<table cellpadding='0' cellspacing='0' style='width:400px;'>\n";
				echo "<tr><th>Include</th><th>Transcript</th><th>Frameshift</th><th>Corrected</th></tr>";
				$start1	= 0; $stop1=(count($transcripts)/2); $two_table=true;
				if(count($transcripts) <5 ){$stop1=(count($transcripts)-1);$two_table=false;}
						
				$last_i	= 0;
				for($i=$start1;$i<=$stop1;$i++){
					$transcript	= $transcripts[$i]['Transcripts'];	
					$transcript_id	= $transcript["transcript_id"];		
					$putative_fs	= $transcript["putative_frameshift"];
					$frame_corrected= $transcript["is_frame_corrected"];
					echo "<tr>";
					if($putative_fs){
						echo "<td><input type='checkbox' name='".$transcript_id."' id='".$transcript_id."' checked='checked'/></td>";
					}
					else{
						echo "<td><input type='checkbox' name='".$transcript_id."' id='".$transcript_id."' /></td>";
					}	
					echo "<td>".$html->link($transcript_id,array("controller"=>"trapid","action"=>"transcript",$exp_id,$transcript_id))."</td>";
					if($putative_fs){echo "<td><span class='message'>V</span></td>";}
					else{echo "<td></td>";}

					if($putative_fs){
						if($frame_corrected){echo "<td><span class='message'>V</span></td>";}
						else{echo "<td><span class='error'>X</span></td>";}
					}
					else{echo "<td></td>";}
		
					echo "</tr>\n";
					$last_i = $i;
				}								
				echo "</table>\n";
				echo "</div>\n";
				if($two_table){
				    echo "<div style='float:left;width:400px;margin-left:20px;'>\n";		
				    echo "<table cellpadding='0' cellspacing='0' style='width:400px;'>\n";
				    echo "<tr><th>Include</th><th>Transcript</th><th>Frameshift</th></tr>";
				    for($i=($last_i+1);$i<(count($transcripts));$i++){
					    $transcript	= $transcripts[$i]['Transcripts'];	
					    $transcript_id	= $transcript["transcript_id"];		
					    $putative_fs	= $transcript["putative_frameshift"];
					    echo "<tr>";
					    if($putative_fs){
						    echo "<td><input type='checkbox' name='".$transcript_id."' id='".$transcript_id."' checked='checked'/></td>";
					    }
					    else{
						    echo "<td><input type='checkbox' name='".$transcript_id."' id='".$transcript_id."' /></td>";
					    }	
					    echo "<td>".$html->link($transcript_id,array("controller"=>"trapid","action"=>"transcript",$exp_id,$transcript_id))."</td>";
					    if($putative_fs){
						    echo "<td><span class='message'>V</span></td>";
					    }
					    else{
						    echo "<td></td>";
					    }		
					    echo "</tr>\n";
				    }								
				    echo "</table>\n";
				    echo "</div>\n";	
				}			
				?>

				<div style='clear:both;width:700px;'>							
				<input type='checkbox' id='all_fs_transcripts' checked='checked'/>
				<span style='margin-left:10px;'>Select all transcripts with putative frameshifts</span> <br/>
				<input type='checkbox' id='all_transcripts' />
				<span style='margin-left:10px;'>Select all transcripts</span>
				<script type='text/javascript'>
				<?php
					$new_transcript_data	= array();
					foreach($transcripts as $transcript){
						$tr	= $transcript['Transcripts'];
						$new_transcript_data[] = array("transcript_id"=>$tr['transcript_id'],
										"putative_frameshift"=>$tr['putative_frameshift']);	
					}	
					echo "var transcript_data=".$javascript->object($new_transcript_data).";";
				?>
				
				//<![CDATA[
					$("all_fs_transcripts").observe("change",function(){						
						for(var i=0;i<transcript_data.length;i++){
							var transcript_id	= transcript_data[i].transcript_id;
							var frameshift		= transcript_data[i].putative_frameshift;
							if(frameshift){
								$(transcript_id).checked=$("all_fs_transcripts").checked;
							}
						}					
					});			
					$("all_transcripts").observe("change",function(){
						for(var i=0;i<transcript_data.length;i++){
							var transcript_id	= transcript_data[i].transcript_id;		
							$(transcript_id).checked=$("all_transcripts").checked;
						}	
					});
				//]]>
				</script>
				</div>
				
				</div>
			</dd>				
		</dl>
		<br/>
		<?php
		if(isset($error)){
			echo "<span class='error'>".$error."</span>\n";
			echo "<br/>\n";
		}
		?>
		
		<?php
		if(isset($job_id)){
		    echo "<div class='subdiv'>";
		    echo "<div id='framedp_div'>";
		    echo "<div style='width:300px;min-height:200px;border:1px solid black;background-color:#F2F2F2'><br/><br/><br/><br/><br/><br/>";
		    echo "<center>";
		    echo $html->image('ajax-loader.gif');
		    echo "<br/><span>Running FrameDP..please wait</span><br/>\n";
		    echo "</center>";
		    echo "</div>";
		    echo "</div>";			
		    echo "</div>\n";
    		    $hide_options	= true;	
		    echo $javascript->codeBlock($ajax->remoteFunction(
			array('url'=>"/tools/load_framedp/".$exp_id."/".$gf_id."/".$job_id."/",
			'update'=>'framedp_div')));
		}
		?>
		

		<input type="submit" value="Perform frameshift correction" />
		</form>


		<?php endif;?>

	</div>
</div>	
</div>