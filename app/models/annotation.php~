<?php
  /*
   */
class Annotation extends AppModel{
  var $name		= "Annotation";
  var $useTable		= "annotation";
  var $useDbConfig 	= "db_plaza_public_02_5";



  function getLengths($species){    
    $query		= "SELECT CHAR_LENGTH(`seq`) as `length` FROM `annotation` WHERE `species`='".$species."' AND `type`='coding'";
    $res		= $this->query($query);  
    $result		= array();
    foreach($res as $r){
      $length		= $r[0]['length'];
      $result[]		= $length;
    }       
    return $result;
  }


  function getGeneSizes($gene_ids){
    $result		= array();
    if(count($gene_ids)==0){return $result;}
    $gene_string	= "('".implode("','",$gene_ids)."')";
    $query		= "SELECT `gene_id`,LENGTH(`seq`) as length FROM `annotation` WHERE `gene_id` IN ".$gene_string;
    $res		= $this->query($query);
    foreach($res as $r){
      $gene_id	= $r['annotation']['gene_id'];
      $length	= $r[0]['length'];
      $result[$gene_id]  = $length;
    }

    return $result;
  }

  function getSpeciesGeneCounts(){
    $query	= "SELECT `species`,count(`gene_id`) as count FROM `annotation` WHERE `type`='coding' GROUP BY `species`";
    $res	= $this->query($query);    
    $result	= array();
    foreach($res as $r){
      $spec	= $r['annotation']['species'];
      $count	= $r[0]['count'];
      $result[$spec] = $count;
    }
    return $result;
  }


  function getSpeciesForGenes($gene_ids){
    $result		= array();
    if(count($gene_ids)==0){return $result;}
    $gene_string	= "('".implode("','",$gene_ids)."')";
    $query		= "SELECT `species`,`gene_id` FROM `annotation` WHERE `gene_id` IN ".$gene_string;
    $res		= $this->query($query);
    foreach($res as $r){
      $spec		= $r['annotation']['species'];
      $gene		= $r['annotation']['gene_id'];
      if(!array_key_exists($spec,$result)){$result[$spec] = array();}
      $result[$spec][] = $gene;      
    }
    return $result;
  }

  function getSpeciesProfile($gene_ids){
    $result			= array();
    if(count($gene_ids)==0){return $result;}
    $gene_string	= "('".implode("','",$gene_ids)."')";
    $query  = "SELECT `species`,COUNT(`gene_id`) as count FROM `annotation` WHERE `gene_id` IN ".$gene_string." GROUP BY `species` ";
    $res	= $this->query($query);
    foreach($res as $r){
      $spec	= $r['annotation']['species'];
      $count	= $r[0]['count'];
      $result[$spec]	= $count;
    }  
    return $result;
  }


}	
?>
